<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://unpkg.com/tabulator-tables@5.2.3/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
        
    <!-- CSS Sanwithz -->
    <link href="https://sanwithz.github.io/tabulatorCss/style.css" rel="stylesheet">

    
    <!-- Tabulator CDN -->
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.2.3/dist/js/tabulator.min.js"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Prompt&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Prompt', sans-serif;
      }
      
      .list {
        background-color: #ffffff;
        padding: 1.8em 1.2em;
        box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        border-radius: 0.6em;
      }

      body {
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        background: rgb(252, 233, 233);
        background: linear-gradient(0deg, rgba(252, 233, 233, 1) 0%, rgba(224, 244, 241, 1) 26%, rgba(255, 255, 255, 1) 71%);
        flex-direction: column;
        padding: 25px;
      }
      
      @media (min-width: 768px) {
    .container, .container-md, .container-sm {
        max-width: 100%;
    }
}
      
    </style>
  </head>
  <body style="padding: 25px;">
    
        <!-- Header -->
    <div class="d-flex align-items-center justify-content-between">
      <h4 class="m-0 fw-bold">ตารางยอดเหรียญรวม | LEADER BOARD</h4>
      <button class="btn btn-outline-secondary" onclick="window.location.href='https://sanwithz.github.io/bio-MiniApp/';">
        <i class="fas fa-home"></i>
      </button>
    </div>
    <hr>
    
    
    <div class="container mt-4">
      <center>
        <h2> <br/>สถิติทั้งหมด</h2>
        <h3 id="total-balance" style="color: green; margin-top: 20px;"></h3>
        <h4 id="remaining-balance" style="color: blue; margin-top: 10px;"></h4>
      </center>
    </div>
    <br>
    <div id="example-table" class="container list"></div>
    <br>
    <div class="container list">
      <h3>การกระจายยอดเหรียญ</h3>
      <br/>
      <canvas id="pieChart"></canvas>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", pageLoad);

    function pageLoad() {
        loadData();
    }

    function loadData() {
        fetch('https://opensheet.elk.sh/1ccAKIMzy4p4yicqq0qjZOTV_Xf7QVZrhsajIykGJKxU/Rank')
            .then(response => response.json())
            .then(tabledata => {
                // Filter the data to include only rows with non-null and non-empty UID
                const filteredData = tabledata
                    .filter(row => row.UID && row.UID.trim() !== "")
                    .map(row => {
                        row.UID = row.UID.slice(0, -4) + "****"; // Blur last 4 digits
                        row["Total Balance"] = parseFloat(row["Total Balance"].replace(/,/g, '')) || 0; // Convert to number
                        return row;
                    });

                console.log(filteredData); // Debugging output

                // Calculate total balance and remaining balance
                const totalBalance = filteredData.reduce((sum, row) => sum + row["Total Balance"], 0);
                const remainingBalance = 21000000 - totalBalance;

                // Display total balance and remaining balance
                document.getElementById("total-balance").innerText = `ยอดรวมทั้งหมด: ${totalBalance.toLocaleString()} เหรียญ`;
                document.getElementById("remaining-balance").innerText = `เหรียญคงเหลือให้ขุด: ${remainingBalance.toLocaleString()} เหรียญ`;

                // Initialize Tabulator with filtered data
                new Tabulator("#example-table", {
                    data: filteredData,
                    layout: "fitColumns",
                    responsiveLayout: "hide",
                    tooltips: true,
                    addRowPos: "top",
                    history: true,
                    pagination: "local",
                    paginationSize: 25,
                    paginationCounter: "rows",
                    movableColumns: true,
                    initialSort: [{ column: "Rank", dir: "asc" }],
                    columns: [
                        { title: "อันดับ", field: "Rank", hozAlign: "left", width: 100,sorter: "number"  },
                        { title: "UID", field: "UID", hozAlign: "left" },
                        {
                            title: "ยอดเหรียญรวม",
                            field: "Total Balance",
                            hozAlign: "left",
                            width: 250,
                            formatter: cell => cell.getValue().toLocaleString(), // Add thousand separator
                        },
                        { title: "NFTs", field: "NFTs", hozAlign: "left", width: 100 },
                        { title: "เหรียญตรา", field: "Badge", hozAlign: "left", width: 120 }
                    ]
                });

                // Create Pie Chart for Total and Remaining Balance
                const ctx = document.getElementById("pieChart").getContext("2d");
                new Chart(ctx, {
                    type: "pie",
                    data: {
                        labels: ["ยอดรวมทั้งหมด", "เหรียญคงเหลือให้ขุด"],
                        datasets: [
                            {
                                label: "การกระจายยอดเหรียญ",
                                data: [totalBalance, remainingBalance],
                                backgroundColor: ["rgba(75, 192, 192, 0.6)", "rgba(192, 75, 192, 0.6)"],
                                borderColor: ["rgba(75, 192, 192, 1)", "rgba(192, 75, 192, 1)"],
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: "top"
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.label}: ${context.raw.toLocaleString()} เหรียญ`;
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error("Error fetching data:", error);
                document.getElementById("example-table").innerHTML =
                    "<p style='color:red;'>Failed to load data. Please try again later.</p>";
            });
    }
</script>

  </body>
</html>
